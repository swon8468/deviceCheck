import{r as h,u as hr,j as e,B as w,T as j,m as C,n as yt,o as mr,D as gr,p as wt,L as xr,z as Ke,a0 as It,_ as pr,q as fr,s as jr,t as yr,v as wr,a1 as Ir,a2 as Sr,w as br,G as Pe,b as ae,c as ne,f as ie,g as ce,h as G,i as c,k as le,l as Z,a3 as _r,a4 as St,d as ee,a5 as bt,a6 as vr,a7 as Dr,A as _t,U as Ae,V as Re,W as Ne,F as P,I as O,S as Q,M as z,X as ke}from"./vendor-mui-EHn5RoE1.js";import{u as Tr,a as Cr,c as q,d as T,g as te,q as E,w as L,o as X,l as qr,b as pe,S as N,e as fe,f as je,h as Ar,L as ye,i as Oe,j as Qe,s as Rr,k as Nr,m as kr,n as Xe,p as vt}from"./dashboard-admin-zNdg3Xgx.js";import"./vendor-react-COd4auuD.js";const lo=()=>{const{currentUser:r,logout:Dt}=Tr(),[de,Tt]=h.useState(0),[Ye,Je]=h.useState(!0),Ze=()=>{Je(!Ye)},[v,$e]=h.useState([]),[Y,Ct]=h.useState([]),[F,qt]=h.useState([]),[J,et]=h.useState([]),[tt,At]=h.useState([]),[$r,Rt]=h.useState([]),[Me,Nt]=h.useState([]),[kt,rt]=h.useState(!0),[ot,B]=h.useState(null),[Ge,st]=h.useState([]),[_,at]=h.useState(null),[re,Ee]=h.useState([]),[$t,we]=h.useState(!1),[b,nt]=h.useState(null),[S,oe]=h.useState({type:"merit",points:"1",reason:"",description:""}),[Ie,Mt]=h.useState({}),[Mr,it]=h.useState([]),[Se,ct]=h.useState([]),[Gr,Er]=h.useState("all"),[Be,Gt]=h.useState(0),[ue,lt]=h.useState(""),[U,Et]=h.useState({key:"createdAt",direction:"desc"}),Bt=hr(),{isMobile:be,isSmallMobile:he,isMobileOrSmaller:k}=Cr(),[Wt,me]=h.useState(!1),[zt,We]=h.useState(!1),[Br,Lt]=h.useState(!1),[Wr,zr]=h.useState(!1),[Lr,Ur]=h.useState(!1),[Hr,Fr]=h.useState(!1),[Vr,Kr]=h.useState(!1),[Ut,_e]=h.useState(!1),[Pr,Or]=h.useState(null),[y,ge]=h.useState(null),[Qr,Xr]=h.useState(null),[M,Ht]=h.useState(null),[V,Yr]=h.useState(""),[$,Ft]=h.useState({key:"createdAt",direction:"desc"}),[W,Vt]=h.useState({key:"studentId",direction:"asc"}),[ve,Jr]=h.useState("all"),[De,Zr]=h.useState("all"),[eo,to]=h.useState([]),[ro,oo]=h.useState(!1);h.useEffect(()=>{console.log("classes/students useEffect 트리거됨:",{classesLength:Y.length,studentsLength:v.length,currentUser:!!r}),Y.length>0&&v.length>0&&r?(console.log("fetchGradeClasses 호출 예정"),gt()):console.log("fetchGradeClasses 호출 조건 미충족:",{classesLength:Y.length,studentsLength:v.length,currentUser:!!r})},[Y,v,r]);const[x,H]=h.useState({studentId:"",type:"demerit",reason:"",value:1,description:""}),[so,ao]=h.useState({title:"",content:"",category:"일반"}),[A,Kt]=h.useState({key:"studentId",direction:"asc"}),ze=t=>{Kt(s=>({key:t,direction:s.key===t&&s.direction==="asc"?"desc":"asc"}))},Le=h.useMemo(()=>V.trim()?v.filter(t=>t.name?.toLowerCase().includes(V.toLowerCase())||t.studentId?.toLowerCase().includes(V.toLowerCase())||t.grade?.toString().includes(V)||t.class?.toString().includes(V)||t.number?.toString().includes(V)||t.birthDate?.includes(V)):v,[v,V]),Pt=h.useMemo(()=>{const t=F.filter(a=>a.status==="pending").length,s=J.filter(a=>a.processedBy===r.uid).length;return{requestedToMe:t,processedByMe:s}},[F,J,r.uid]),Te=t=>{Ft(s=>({key:t,direction:s.key===t&&s.direction==="asc"?"desc":"asc"}))},Ot=async t=>{try{(await N.fire({title:"요청 승인",text:"이 요청을 승인하시겠습니까?",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"승인",cancelButtonText:"취소"})).isConfirmed&&(await dt(t,"approved"),await N.fire({title:"성공",text:"요청이 승인되었습니다.",icon:"success"}))}catch(s){console.error("요청 승인 오류:",s),await N.fire({title:"오류",text:"요청 승인 중 오류가 발생했습니다: "+s.message,icon:"error"})}},Qt=async t=>{try{(await N.fire({title:"요청 거부",text:"이 요청을 거부하시겠습니까?",icon:"question",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"거부",cancelButtonText:"취소"})).isConfirmed&&(await dt(t,"rejected"),await N.fire({title:"성공",text:"요청이 거부되었습니다.",icon:"success"}))}catch(s){console.error("요청 거부 오류:",s),await N.fire({title:"오류",text:"요청 거부 중 오류가 발생했습니다: "+s.message,icon:"error"})}},dt=async(t,s)=>{try{const a=fe(T,"merit_demerit_requests",t),n=await Qe(a);if(!n.exists())throw new Error("요청을 찾을 수 없습니다.");const o=n.data();console.log("=== handleRequestAction 디버깅 ==="),console.log("requestId:",t),console.log("status:",s),console.log("requestData:",o),console.log("requestData.studentId:",o.studentId),console.log("requestData.student_id:",o.student_id),console.log("requestData.points:",o.points),console.log("requestData.value:",o.value),await Xe(r,ye.MERIT_MANAGEMENT.middle.PROCESS,`상벌점 요청 ${s==="approved"?"승인":"거부"}`,`요청 ID: ${t}`),await je(a,{status:s,responseAt:new Date,responseNote:s==="approved"?"담임 교사 승인":"담임 교사 거부"});try{await pe(q(T,"system_logs"),{userId:r.uid,userName:r.name||r.email,userRole:r.role,majorCategory:"상벌점 관리",middleCategory:"상벌점 요청 처리",minorCategory:"",action:`상벌점 요청 ${s==="approved"?"승인":"거부"}`,details:`${r.name||r.email}님이 ${o.studentName||"학생"}의 상벌점 요청을 ${s==="approved"?"승인":"거부"}했습니다. (요청 교사: ${o.requestingTeacherName||"교과목 교사"})`,timestamp:new Date,createdAt:new Date})}catch(i){console.error("시스템 로그 기록 오류:",i)}if(s==="approved"){const i=o.studentId||o.student_id;if(console.log("=== studentId 디버깅 ==="),console.log("requestData.studentId:",o.studentId),console.log("requestData.student_id:",o.student_id),console.log("최종 studentId:",i),!i)throw console.error("studentId를 찾을 수 없습니다. requestData 전체:",o),new Error("학생 ID를 찾을 수 없습니다.");const d={studentId:i,studentName:o.studentName||o.student_name,type:o.type,reason:o.reason,points:o.points||o.value,value:o.points||o.value,description:o.description||"",creatorId:o.requestingTeacherId||o.requester_id,creatorName:o.requestingTeacherName||o.requester_name,creatorRole:"subject_teacher",processedBy:o.requestingTeacherId||o.requester_id,processedByName:o.requestingTeacherName||o.requester_name||o.teacherName||o.teacher_name,status:"approved",requestTeacherId:o.requestingTeacherId||o.requester_id,createdAt:new Date,updatedAt:new Date,changeHistory:[{changedBy:r.uid,changedAt:new Date,oldValue:null,newValue:o.points||o.value||0,oldReason:null,newReason:o.reason}]};await pe(q(T,"merit_demerit_records"),d);const l=fe(T,"accounts",i),m=await Qe(l);if(m.exists()){const p=m.data().cumulativeScore||0,f=o.points||o.value||0,I=p+f;console.log("=== cumulativeScore 업데이트 디버깅 ==="),console.log("현재 점수:",p),console.log("추가할 점수:",f),console.log("새로운 점수:",I),console.log("요청 타입:",o.type),await je(l,{cumulativeScore:I,updatedAt:new Date})}}await ht(),await Ue()}catch(a){throw console.error("요청 처리 오류:",a),a}},xe=h.useMemo(()=>$.key?[...J].sort((t,s)=>{let a=0;if($.key==="createdAt"){const n=new Date(t.createdAt),o=new Date(s.createdAt);a=n-o}else{const n=t[$.key],o=s[$.key];if(n==null)return 1;if(o==null)return-1;typeof n=="string"&&typeof o=="string"?a=n.localeCompare(o,"ko-KR"):typeof n=="number"&&typeof o=="number"?a=n-o:a=String(n).localeCompare(String(o),"ko-KR")}return $.direction==="asc"?a:-a}):J,[J,$]);h.useMemo(()=>ve==="all"?F:ve==="pending"?F.filter(t=>t.status==="pending"):ve==="processed"?F.filter(t=>t.status==="processed"):F,[F,ve]),h.useMemo(()=>De==="all"?xe:De==="merit"?xe.filter(t=>t.type==="merit"):De==="demerit"?xe.filter(t=>t.type==="demerit"):xe,[xe,De]);const ut=h.useMemo(()=>{if(!re||re.length===0)return[];let t=re;if(ue.trim()){const s=ue.toLowerCase().trim();t=re.filter(a=>{const n=(a.name||"").toLowerCase(),o=(a.studentId||a.id||"").toLowerCase(),i=(a.homeroomTeacher||"").toLowerCase(),d=(a.homeroomTeacherName||"").toLowerCase();return n.includes(s)||o.includes(s)||i.includes(s)||d.includes(s)})}return W.key?[...t].sort((s,a)=>{let n=0;if(W.key==="studentId")n=(s.studentId||s.id||"").localeCompare(a.studentId||a.id||"");else if(W.key==="name")n=(s.name||"").localeCompare(a.name||"");else if(W.key==="homeroomTeacher"){const o=qe(s),i=qe(a);n=o.localeCompare(i)}return W.direction==="asc"?n:-n}):t},[re,W,Ge,ue]),Xt=h.useMemo(()=>A.key?[...Le].sort((t,s)=>{let a=0;if(A.key==="grade"){const n=parseInt(t.grade)||0,o=parseInt(s.grade)||0,i=parseInt(t.class)||0,d=parseInt(s.class)||0,l=parseInt(t.number)||0,m=parseInt(s.number)||0;n!==o?a=n-o:i!==d?a=i-d:a=l-m}else if(A.key==="name"){const n=t.name||"",o=s.name||"";a=n.localeCompare(o,"ko-KR")}else if(A.key==="studentId"){const n=t.studentId||t.id||"",o=s.studentId||s.id||"";a=n.localeCompare(o,"ko-KR")}else if(A.key==="cumulativeScore"){const n=t.cumulativeScore||0,o=s.cumulativeScore||0;a=n-o}else{const n=t[A.key],o=s[A.key];if(n==null)return 1;if(o==null)return-1;typeof n=="string"&&typeof o=="string"?a=n.localeCompare(o,"ko-KR"):typeof n=="number"&&typeof o=="number"?a=n-o:a=String(n).localeCompare(String(o),"ko-KR")}return A.direction==="asc"?a:-a}):Le,[Le,A]);h.useEffect(()=>{if(r){let t=null,s=null,a=null;const n=()=>{t&&t(),s&&s(),a&&a()},o=()=>{n()};return(async()=>{try{n(),await Yt(),await ht(),a=await Ue(),await er(),await tr(),await gt(),(()=>{const l=q(T,"classes"),m=E(l);s=X(m,p=>{const f=p.docs.map(u=>({id:u.id,...u.data()}));console.log("=== 클래스 데이터 상세 디버깅 ==="),console.log("전체 클래스 개수:",f.length),f.forEach((u,R)=>{console.log(`클래스 ${R+1}:`,{id:u.id,name:u.name,grade:u.grade,class:u.class,homeroom_teacher:u.homeroom_teacher,homeroom_teacher_id:u.homeroom_teacher_id,homeroom_teacher_name:u.homeroom_teacher_name,homeroom_teacher_email:u.homeroom_teacher_email,teacher_name:u.teacher_name,teacher_email:u.teacher_email})}),Ct(f),console.log("=== 클래스 정보 실시간 업데이트 시작 ==="),console.log("클래스 정보 실시간 업데이트:",f.length,"개 클래스"),console.log("현재 사용자 정보:",{uid:r.uid,id:r.id,name:r.name,role:r.role}),console.log("현재 사용자 전체 객체:",r),console.log("모든 클래스 정보:",f),f.forEach((u,R)=>{console.log(`클래스 ${R+1} 상세 정보:`,{id:u.id,name:u.name,grade:u.grade,class:u.class,homeroomTeacher:u.homeroomTeacher,homeroomTeacherId:u.homeroomTeacherId,teacherId:u.teacherId,담임교사:u.담임교사,담임교사ID:u.담임교사ID,모든_필드:Object.keys(u),전체_데이터:u})});const I=f.filter(u=>{const R=r.uid||r.id||r.userId,K=r.email;console.log("사용자 ID 확인:",{uid:r.uid,id:r.id,userId:r.userId,email:r.email,최종_사용자_ID:R});const D=u.homeroomTeacher===R||u.homeroomTeacherId===R||u.homeroomTeacher===r.uid||u.homeroomTeacherId===r.uid||u.homeroomTeacher===r.id||u.homeroomTeacherId===r.id||u.homeroomTeacher===K||u.homeroomTeacherId===K;return console.log(`실시간 클래스 ${u.grade}학년 ${u.class}반 담당 교사 검사:`,{클래스_ID:u.id,homeroomTeacher:u.homeroomTeacher,homeroomTeacherId:u.homeroomTeacherId,currentUserUid:r.uid,currentUserId:r.id,최종_사용자_ID:R,사용자_이메일:K,isAssigned:D,매칭_상세:{homeroomTeacher_최종ID_매칭:u.homeroomTeacher===R,homeroomTeacherId_최종ID_매칭:u.homeroomTeacherId===R,homeroomTeacher_uid_매칭:u.homeroomTeacher===r.uid,homeroomTeacherId_uid_매칭:u.homeroomTeacherId===r.uid,homeroomTeacher_id_매칭:u.homeroomTeacher===r.id,homeroomTeacherId_id_매칭:u.homeroomTeacherId===r.id,homeroomTeacher_이메일_매칭:u.homeroomTeacher===K,homeroomTeacherId_이메일_매칭:u.homeroomTeacherId===K}}),D});if(console.log("실시간 - 전체 클래스 수:",f.length),console.log("실시간 - 담당 클래스 수:",I.length),console.log("실시간 - 담당 클래스들:",I),I.length!==1){console.warn(`실시간 - 담당 클래스가 ${I.length}개입니다. 정확히 1개여야 합니다.`),console.log("실시간 - 담당 클래스가 1개가 아니므로 학생 목록 초기화"),$e([]);return}const g=new Set,se=new Set;I.forEach(u=>{g.add(`${u.grade}-${u.class}`),se.add(u.id),console.log(`실시간 - 담당 클래스 추가: ${u.grade}학년 ${u.class}반 (ID: ${u.id})`)}),console.log("실시간 - 유효한 클래스 키들:",Array.from(g)),console.log("실시간 - 유효한 클래스 ID들:",Array.from(se)),t&&(console.log("기존 학생 리스너 정리"),t());const xt=q(T,"accounts"),ur=E(xt,L("role","==","student"));t=X(ur,u=>{const R=[];console.log("=== 학생 필터링 시작 ==="),console.log("실시간 - 전체 학생 수:",u.size),console.log("실시간 - 유효한 클래스 키들:",Array.from(g)),console.log("현재 사용자 정보 (학생 필터링):",{uid:r.uid,id:r.id,name:r.name,role:r.role}),u.forEach(K=>{const D=K.data(),pt=`${D.grade}-${D.class}`,Fe=g.has(pt),ft=r.uid||r.id||r.userId,jt=r.email,Ve=D.homeroomTeacher===ft||D.homeroomTeacherId===ft||D.homeroomTeacher===r.uid||D.homeroomTeacherId===r.uid||D.homeroomTeacher===r.id||D.homeroomTeacherId===r.id||D.homeroomTeacher===jt||D.homeroomTeacherId===jt;console.log(`실시간 - 학생 ${D.name} (${D.grade}학년 ${D.class}반) 검사:`,{classKey:pt,studentClassId:D.classId,studentHomeroomTeacher:D.homeroomTeacher,studentHomeroomTeacherId:D.homeroomTeacherId,currentUserUid:r.uid,currentUserId:r.id,isInAssignedClass:Fe,isHomeroomTeacherMatch:Ve,validClassKeys:Array.from(g)}),Fe&&Ve?(console.log(`✓ 실시간 - 학생 ${D.name} 추가됨 - 담당 클래스이고 담임 교사 일치`),R.push({id:K.id,...D})):Fe?Ve||console.log(`✗ 실시간 - 학생 ${D.name} 제외됨 - 담임 교사가 일치하지 않음`):console.log(`✗ 실시간 - 학생 ${D.name} 제외됨 - 담당 클래스가 아님`)}),console.log("=== 학생 필터링 결과 ==="),console.log("실시간 - 최종 필터링된 학생들:",R),console.log("실시간 - 필터링된 학생 수:",R.length),console.log("=== 학생 필터링 완료 ==="),$e(R)},u=>{console.error("학생 실시간 업데이트 오류:",u)})},p=>{console.error("클래스 실시간 업데이트 오류:",p)})})();try{await pe(q(T,"system_logs"),{userId:r.uid,userName:r.name||r.email,userRole:r.role,majorCategory:"교사 활동",middleCategory:"대시보드 접근",minorCategory:"",action:"담임 교사 대시보드 접근",details:`${r.name||r.email}님이 담임 교사 대시보드에 접근했습니다.`,timestamp:new Date,createdAt:new Date})}catch(l){console.error("시스템 로그 기록 오류:",l)}console.log("=== 담임 교사 대시보드 초기화 완료 ==="),console.log("현재 사용자:",r),console.log("실시간 리스너 설정 완료")}catch(d){B(d.message)}})(),console.log("담임교사 useEffect - fetchMeritReasons 호출"),rr(),console.log("담임교사 useEffect - fetchGradeRequests 호출"),or(),o}},[r]);const Yt=async()=>{try{const t=q(T,"accounts"),s=E(t,L("role","==","student")),a=await te(s);console.log("전체 학생 수:",a.size);const n=r.uid||r.id||r.userId,o=r.email,i=[];a.forEach(d=>{const l=d.data(),m=l.homeroomTeacher===n||l.homeroomTeacherId===n||l.homeroomTeacher===r.uid||l.homeroomTeacherId===r.uid||l.homeroomTeacher===r.id||l.homeroomTeacherId===r.id||l.homeroomTeacher===o||l.homeroomTeacherId===o;console.log(`학생 ${l.name} 검사:`,{studentId:d.id,homeroomTeacher:l.homeroomTeacher,homeroomTeacherId:l.homeroomTeacherId,currentUserUid:r.uid,currentUserId:r.id,최종_사용자_ID:n,사용자_이메일:o,isMyStudent:m}),m&&i.push({id:d.id,...l})}),console.log("내 담당 학생 수:",i.length),console.log("내 담당 학생들:",i),$e(i),rt(!1)}catch(t){B(t.message),rt(!1)}},ht=async()=>{try{console.log("fetchPendingRequests 호출됨, currentUser.uid:",r.uid);const t=q(T,"merit_demerit_requests"),s=E(t,L("status","==","pending"));return X(s,n=>{console.log("전체 상벌점 요청 조회 결과:",n.size,"개"),console.log("모든 요청들:",n.docs.map(i=>({id:i.id,...i.data()})));const o=n.docs.map(i=>{const d=i.data();return{id:i.id,...d,requesterName:d.requestingTeacherName||d.requester_name||d.requesterName||d.teacherName||d.teacher_name||"알 수 없음",studentName:d.studentName||d.student_name||"알 수 없음",points:d.points||d.value||0,reason:d.reason||d.meritReason||"N/A",description:d.description||d.detailDescription||"",createdAt:d.createdAt?.toDate?.()||new Date(d.createdAt||d.requestedAt?.toDate?.()||new Date)}}).filter(i=>{const d=i.homeroomTeacherId===r.uid||i.homeroom_teacher_id===r.uid||i.homeroomTeacher===r.uid||i.homeroom_teacher===r.uid||i.teacherId===r.uid;return console.log(`요청 ${i.id}: homeroomTeacherId=${i.homeroomTeacherId}, homeroom_teacher_id=${i.homeroom_teacher_id}, homeroomTeacher=${i.homeroomTeacher}, homeroom_teacher=${i.homeroom_teacher}, teacherId=${i.teacherId}, 현재UID=${r.uid}, 매칭=${d}`),d}).sort((i,d)=>new Date(d.createdAt)-new Date(i.createdAt));console.log("필터링된 요청 데이터:",o),qt(o)},n=>{console.error("상벌점 요청 조회 오류:",n),B(n.message)})}catch(t){return console.error("fetchPendingRequests 오류:",t),B(t.message),null}},Ue=async()=>{try{console.log("=== fetchMeritRecords 디버깅 시작 ==="),console.log("현재 사용자 UID:",r.uid),console.log("담당 학생들:",v.map(f=>({id:f.id,name:f.name,class:f.class})));const t=v.map(f=>f.id);if(console.log("본인 클래스 학생 ID 목록:",t),t.length===0)return console.log("담당 학생이 없습니다."),et([]),null;let s=[],a=[];const n=()=>{const f=[...s,...a].sort((I,g)=>{const se=I.createdAt?.getTime?.()||new Date(I.createdAt).getTime();return(g.createdAt?.getTime?.()||new Date(g.createdAt).getTime())-se});console.log("통합된 상벌점 내역:",f.length,"개 (기록:",s.length,"개, 요청:",a.length,"개)"),et(f)},o=q(T,"merit_demerit_records"),i=E(o,vt("createdAt","desc")),d=q(T,"merit_demerit_requests"),l=E(d,vt("createdAt","desc")),m=X(i,f=>{console.log("전체 상벌점 기록 조회 결과:",f.size,"개"),s=f.docs.map(I=>({id:I.id,...I.data(),createdAt:I.data().createdAt?.toDate?.()||new Date(I.data().createdAt),source:"record"})).filter(I=>t.includes(I.studentId)),console.log("필터링된 상벌점 기록:",s.length,"개"),n()},f=>{console.error("상벌점 기록 조회 오류:",f),B(f.message)}),p=X(l,f=>{console.log("전체 상벌점 요청 조회 결과:",f.size,"개"),a=f.docs.map(I=>{const g=I.data();return{id:I.id,studentId:g.studentId||g.student_id,studentName:g.studentName||g.student_name||"알 수 없음",type:g.type||"demerit",points:g.points||g.value||0,reason:g.reason||g.meritReason||"",description:g.description||g.detailDescription||"",requestingTeacherName:g.requestingTeacherName||g.requester_name||g.requesterName||"알 수 없음",requestingTeacherId:g.requestingTeacherId||g.requester_id,status:g.status||"pending",createdAt:g.createdAt?.toDate?.()||new Date(g.createdAt||g.requestedAt?.toDate?.()||new Date),responseAt:g.responseAt?.toDate?.()||(g.responseAt?new Date(g.responseAt):null),responseNote:g.responseNote||"",source:"request",processedTeacherName:g.status==="approved"?r.name||"담임교사":"",teacherName:g.requestingTeacherName||g.requester_name||g.requesterName||"알 수 없음",creatorName:g.requestingTeacherName||g.requester_name||g.requesterName||"알 수 없음",homeroomTeacherId:g.homeroomTeacherId||g.homeroom_teacher_id,homeroomTeacher:g.homeroomTeacher||g.homeroom_teacher}}).filter(I=>{const g=t.includes(I.studentId),se=I.homeroomTeacherId===r.uid||I.homeroom_teacher_id===r.uid||I.homeroomTeacher===r.uid||I.homeroom_teacher===r.uid;return g&&se}),console.log("필터링된 상벌점 요청:",a.length,"개"),n()},f=>{console.error("상벌점 요청 조회 오류:",f),B(f.message)});return()=>{m(),p()}}catch(t){return console.error("fetchMeritRecords 오류:",t),B(t.message),null}},Jt=async t=>{try{console.log("=== 특정 학생 상벌점 기록 조회 시작 ==="),console.log("조회할 학생 ID:",t);const s=q(T,"merit_demerit_records"),a=E(s,L("studentId","==",t));console.log("쿼리 실행 (studentId):",t);const n=await te(a);console.log("쿼리 결과:",n.size,"개");const i=n.docs.filter((l,m,p)=>m===p.findIndex(f=>f.id===l.id));console.log("중복 제거 후 총 문서 수:",i.length);const d=i.map(l=>{const m=l.data();console.log("문서 데이터:",l.id,m);let p="N/A";return m.processedByName?p=m.processedByName:m.requesterName?p=m.requesterName:m.teacherName?p=m.teacherName:m.creatorRole==="homeroom_teacher"&&m.creatorName&&(p=m.creatorName),{id:l.id,...m,points:m.points||m.value||0,createdAt:m.createdAt?.toDate?.()||new Date(m.createdAt),processedTeacherName:p}});return d.sort((l,m)=>{const p=l.createdAt||new Date(0);return(m.createdAt||new Date(0))-p}),console.log("최종 상벌점 기록:",d),d}catch(s){return console.error("특정 학생 상벌점 기록 조회 오류:",s),[]}},Zt=async()=>{const t=Date.now();try{if(console.log("=== 상벌점 등록 시작 ==="),console.log("선택된 학생:",y),console.log("상벌점 폼 데이터:",x),console.log("요청자:",r.name||r.email),console.log("요청 시간:",new Date().toLocaleString()),await Ar(r,ye.SECURITY.middle.LOGIN_ATTEMPT,"상벌점 등록 시도",`학생: ${y?.name||"N/A"}, 유형: ${x.type||"N/A"}, 점수: ${x.value||"N/A"}`),!y){await Oe(r,new Error("학생이 선택되지 않음"),"상벌점 등록 - 학생 선택 오류",{meritForm:x}),await N.fire({title:"오류",text:"학생을 선택해주세요.",icon:"error"});return}if(!x.type||!x.reason||!x.value){await Oe(r,new Error("필수 필드 누락"),"상벌점 등록 - 필수 필드 누락",{meritForm:x,selectedStudent:y.name}),await N.fire({title:"오류",text:"모든 필드를 입력해주세요.",icon:"error"});return}const s={studentId:y.id,studentName:y.name,studentGrade:y.grade,studentClass:y.class,studentNumber:y.number,type:x.type,points:x.type==="merit"?x.value:-x.value,reason:x.reason,description:x.description||"",teacherId:r.uid,teacherName:r.displayName||r.name||"담임교사",homeroomTeacherId:r.uid,creatorId:r.uid,creatorName:r.name||r.displayName||"담임교사",creatorRole:"homeroom_teacher",requestingTeacherId:r.uid,requestingTeacherName:r.name||r.displayName||"담임교사",requestingTeacherUid:r.uid,requester_id:r.uid,requester_name:r.name||r.displayName||"담임교사",requester_role:"homeroom_teacher",createdAt:new Date,status:"approved"};console.log("생성할 상벌점 기록:",s);const a=q(T,"merit_demerit_records"),n=await pe(a,s);console.log("merit_demerit_records 저장 완료:",n.id);const o=fe(T,"accounts",y.id),i=y.cumulativeScore||0,d=i+s.points;console.log("=== 학생 점수 업데이트 시작 ==="),console.log(`학생 ID: ${y.id}`),console.log(`학생 이름: ${y.name}`),console.log(`현재 점수: ${i}`),console.log(`추가할 점수: ${s.points}`),console.log(`새로운 점수: ${d}`);try{const p=await Qe(o);console.log(`accounts 문서 존재 여부: ${p.exists()}`),p.exists()?(console.log("기존 accounts 문서 업데이트 중..."),await je(o,{cumulativeScore:d}),console.log(`✅ 학생 ${y.name}의 누적 점수 업데이트 완료: ${i} → ${d}`)):(console.log("새 accounts 문서 생성 중..."),await Rr(o,{id:y.id,name:y.name,studentId:y.studentId||y.id,grade:y.grade,class:y.class,number:y.number,role:"student",cumulativeScore:d,createdAt:new Date,updatedAt:new Date}),console.log(`✅ 학생 ${y.name}의 accounts 문서 생성 및 누적 점수 설정 완료: ${d}`)),console.log("=== 학생 점수 업데이트 완료 ===")}catch(p){console.error("❌ 학생 점수 업데이트 중 오류:",p)}const m=Date.now()-t;await Nr(r,ye.MERIT_MANAGEMENT.major,ye.MERIT_MANAGEMENT.middle.CREATE,"상벌점 등록 완료",`학생 ${y.name}에게 ${x.type==="merit"?"상점":"벌점"} ${Math.abs(x.value)}점 등록`,{studentId:y.id,studentName:y.name,meritType:x.type,points:x.value,reason:x.reason,description:x.description,duration:m,operation:"merit_registration"}),await kr(r,"상벌점 등록",m,{studentName:y.name,meritType:x.type,points:x.value}),await Xe(r,ye.MERIT_MANAGEMENT.middle.CREATE,`상벌점 등록: ${y.name} (${x.type==="merit"?"상점":"벌점"} ${Math.abs(x.value)}점)`),console.log("=== 상벌점 등록 완료 ==="),console.log("소요 시간:",m,"ms"),console.log("등록된 상벌점:",x.type,Math.abs(x.value),"점"),console.log("대상 학생:",y.name),me(!1),H({studentId:"",type:"demerit",reason:"",value:1,description:""}),ge(null),await Ue(),await N.fire({title:"성공",text:"상벌점이 성공적으로 등록되었습니다!",icon:"success"})}catch(s){console.error("상벌점 등록 오류:",s),await Oe(r,s,"상벌점 등록",{studentId:y?.id,studentName:y?.name,meritForm:x,operation:"handleMeritSubmit"}),await N.fire({title:"오류",text:"상벌점 등록 중 오류가 발생했습니다: "+s.message,icon:"error"})}},er=async()=>{try{const t=q(T,"reset_requests"),s=E(t,L("teacherId","==",r.uid),L("status","==","pending"));return X(s,n=>{const o=n.docs.map(i=>({id:i.id,...i.data(),requestedAt:i.data().requestedAt?.toDate?.()||new Date(i.data().requestedAt),expiresAt:i.data().expiresAt?.toDate?.()||new Date(i.data().expiresAt)})).sort((i,d)=>new Date(d.requestedAt)-new Date(i.createdAt));At(o)},n=>{B(n.message)})}catch{return null}},tr=async()=>{try{console.log("fetchInquiries 호출됨, currentUser:",r),console.log("currentUser.uid:",r?.uid);const t=q(T,"inquiries"),s=E(t,L("userId","==",r.uid));return X(s,n=>{console.log("문의 조회 결과:",n.size,"개");const o=n.docs.map(i=>({id:i.id,...i.data(),createdAt:i.data().createdAt?.toDate?.()||new Date(i.data().createdAt),updatedAt:i.data().updatedAt?.toDate?.()||new Date(i.data().updatedAt)})).sort((i,d)=>new Date(d.createdAt)-new Date(i.createdAt));console.log("문의 데이터:",o),Rt(o)},n=>{console.error("문의 조회 오류:",n),B(n.message)})}catch(t){return console.error("fetchInquiries 오류:",t),B(t.message),null}},rr=async()=>{try{console.log("담임교사 - fetchMeritReasons 시작");const t=q(T,"merit_reasons"),a=(await te(t)).docs.map(n=>({id:n.id,...n.data()}));console.log("담임교사 - 가져온 상벌점 사유들:",a),Nt(a)}catch(t){console.error("상벌점 사유 조회 오류:",t)}},or=async()=>{try{console.log("=== fetchGradeRequests 디버깅 시작 ==="),console.log("현재 사용자 UID:",r.uid),console.log("현재 사용자 UID 타입:",typeof r.uid),console.log("현재 사용자 UID 길이:",r.uid?.length);const t=q(T,"merit_demerit_requests"),s=E(t),a=await te(s);console.log("전체 상벌점 요청 개수:",a.size),a.docs.forEach((l,m)=>{const p=l.data();console.log(`요청 ${m+1}:`,{id:l.id,requester_id:p.requester_id,requester_role:p.requester_role,studentName:p.studentName||p.student_name,status:p.status})});const n=E(t,L("requester_id","==",r.uid),L("requester_role","==","homeroom_teacher")),o=await te(n);console.log("필터링된 학년 관리 요청 조회 결과:",o.size,"개"),o.size===0&&console.log("필터링 결과가 없습니다. requester_id와 requester_role을 다시 확인해보세요.");const i=o.docs.map(l=>({id:l.id,...l.data(),createdAt:l.data().createdAt?.toDate?.()||new Date(l.data().createdAt),requestedAt:l.data().requestedAt?.toDate?.()||new Date(l.data().requestedAt)})).sort((l,m)=>new Date(m.createdAt)-new Date(l.createdAt));return console.log("학년 관리 요청 데이터:",i),it(i),ct(i),X(n,l=>{console.log("실시간 업데이트 - 학년 관리 요청 조회 결과:",l.size,"개");const m=l.docs.map(p=>({id:p.id,...p.data(),createdAt:p.data().createdAt?.toDate?.()||new Date(p.data().createdAt),requestedAt:p.data().requestedAt?.toDate?.()||new Date(p.data().requestedAt)})).sort((p,f)=>new Date(f.createdAt)-new Date(p.createdAt));it(m),ct(m)},l=>{console.error("학년 관리 요청 실시간 조회 오류:",l),B(l.message)})}catch(t){return console.error("fetchGradeRequests 오류:",t),B(t.message),null}},sr=async t=>{try{const s=fe(T,"merit_demerit_requests",t);await je(s,{status:"approved",approvedAt:new Date,approvedBy:r.uid}),console.log("학년 관리 요청 승인 완료:",t)}catch(s){console.error("학년 관리 요청 승인 오류:",s)}},ar=async t=>{try{const s=fe(T,"merit_demerit_requests",t);await je(s,{status:"rejected",rejectedAt:new Date,rejectedBy:r.uid}),console.log("학년 관리 요청 거부 완료:",t)}catch(s){console.error("학년 관리 요청 거부 오류:",s)}},mt=async t=>{if(!t||Ie[t])return Ie[t]||null;try{const s=q(T,"accounts"),a=E(s,L("uid","==",t)),n=await te(a);if(!n.empty){const o=n.docs[0],i={name:o.data().name||o.data().displayName||"알 수 없음",email:o.data().email||""};return Mt(d=>({...d,[t]:i})),i}return null}catch(s){return console.error("교사 정보 조회 오류:",s),null}},gt=async()=>{try{if(console.log("=== fetchGradeClasses 디버깅 시작 ==="),console.log("현재 사용자 UID:",r?.uid),console.log("클래스 목록 개수:",Y.length),console.log("현재 내 담당 학생들:",v),v.length===0){console.log("내 담당 학생이 없어서 학년을 확인할 수 없습니다."),st([]);return}const t=v[0].grade;console.log("내 클래스 학년:",t);const s=v.map(o=>o.class);console.log("내가 담당하는 반들:",s);const a=Y.filter(o=>o.grade===t&&!s.includes(o.class));console.log("같은 학년이지만 내가 담당하지 않는 클래스들:",a),st(a);const n=a.map(o=>o.homeroomTeacherId||o.homeroom_teacher_id||o.homeroom_teacher||o.teacher_id).filter(o=>o&&o.trim()!=="");console.log("로드할 교사 UID들:",n),n.forEach(o=>{Ie[o]||mt(o)}),setTimeout(()=>{nr()},100),console.log("=== fetchGradeClasses 디버깅 끝 ===")}catch(t){console.error("학년 클래스 조회 오류:",t)}},nr=async()=>{try{if(console.log("=== fetchGradeStudents 디버깅 시작 ==="),console.log("현재 내 담당 학생들:",v),console.log("현재 클래스 목록:",Y),v.length===0){console.log("내 담당 학생이 없습니다."),Ee([]);return}const t=v[0].grade;if(!t){console.log("학년 정보를 확인할 수 없습니다."),Ee([]);return}console.log("내 담당 클래스 학년:",t);const s=[...new Set(v.map(l=>l.class).filter(l=>l))];console.log("본인 학급 반 번호들:",s);const a=v.map(l=>l.id);console.log("본인 학급 학생 ID들:",a);const n=q(T,"accounts"),o=E(n,L("role","==","student")),i=await te(o);console.log("전체 학생 수:",i.size);const d=[];i.forEach(l=>{const m=l.data(),p=m.grade===t,f=!(p&&s.includes(m.class)),I=!a.includes(l.id);console.log(`학생 ${m.name} (${m.grade}학년 ${m.class}반) 검사:`,{isSameGrade:p,isNotMyClass:f,isNotMyStudent:I,studentId:l.id}),p&&f&&I?(console.log(`✓ 학생 ${m.name} 추가됨 - 같은 학년, 본인 학급이 아님`),d.push({id:l.id,...m})):p?f?I||console.log(`✗ 학생 ${m.name} 제외됨 - 본인 담당 학생`):console.log(`✗ 학생 ${m.name} 제외됨 - 본인 학급`):console.log(`✗ 학생 ${m.name} 제외됨 - 다른 학년 (${m.grade}학년)`)}),console.log("최종 학년 관리 학생 데이터:",d),Ee(d),console.log("=== fetchGradeStudents 디버깅 끝 ===")}catch(t){console.error("학년 학생 조회 오류:",t)}},He=t=>{Vt(s=>({key:t,direction:s.key===t&&s.direction==="asc"?"desc":"asc"}))},Ce=t=>{Et(s=>({key:t,direction:s.key===t&&s.direction==="asc"?"desc":"asc"}))},ir=h.useMemo(()=>!Se||Se.length===0?[]:[...Se].sort((t,s)=>{const{key:a,direction:n}=U;let o,i;switch(a){case"studentName":o=t.studentName||"",i=s.studentName||"";break;case"requesterName":o=t.requesterName||"",i=s.requesterName||"";break;case"requestContent":o=t.requestContent||"",i=s.requestContent||"";break;case"createdAt":o=t.createdAt?.toDate?.()||new Date(0),i=s.createdAt?.toDate?.()||new Date(0);break;default:return 0}return o<i?n==="asc"?-1:1:o>i?n==="asc"?1:-1:0}),[Se,U]),qe=t=>{console.log("=== getHomeroomTeacherDisplay 디버깅 ==="),console.log("학생:",t.name,"학년/반:",t.grade,t.class),console.log("학생 데이터:",t);const s=t.homeroomTeacherId||t.homeroom_teacher_id||t.homeroom_teacher||t.teacher_id||"";if(console.log("담임교사 UID:",s),s&&s.trim()!==""){const o=Ie[s];if(o){const i=k?o.name:o.email&&o.email.trim()!==""?`${o.name}(${o.email})`:o.name;return console.log("캐시된 담임교사 정보:",o,"표시:",i),i}else return mt(s),"교사 정보 로딩 중..."}const a=t.homeroom_teacher_name||t.teacher_name||t.teacher||t.homeroomTeacherName||"담임교사 없음",n=t.homeroomTeacherEmail||t.homeroom_teacher_email||t.teacher_email||t.email||"";return console.log("담임교사 이름 (학생 데이터):",a),console.log("담임교사 이메일 (학생 데이터):",n),k?a:n&&n.trim()!==""?`${a}(${n})`:a},cr=t=>{console.log("=== handleGradeMeritRequest 디버깅 시작 ==="),console.log("선택된 학생:",t),console.log("사용 가능한 클래스들:",Ge);const s=Ge.find(a=>a.grade===t.grade&&a.class===t.class);if(console.log("찾은 클래스:",s),s)at(s);else{console.warn("클래스를 찾을 수 없습니다. 기본 정보로 진행합니다.");const a={id:`fallback_${t.grade}_${t.class}`,name:`${t.grade}학년 ${t.class}반`,grade:t.grade,class:t.class,homeroom_teacher:"알 수 없음",homeroom_teacher_email:"",homeroom_teacher_id:""};at(a)}nt(t),oe({type:"demerit",points:"1",reason:"",description:""}),we(!0)},lr=async()=>{try{if(console.log("=== handleGradeMeritSubmit 디버깅 시작 ==="),console.log("selectedGradeStudent:",b),console.log("selectedGradeClass:",_),console.log("gradeMeritForm:",S),!S.points||!S.reason){await N.fire({icon:"warning",title:"입력 오류",text:"점수와 사유를 모두 입력해주세요."});return}if(!b){await N.fire({icon:"error",title:"오류",text:"학생 정보를 찾을 수 없습니다."});return}if(!_){await N.fire({icon:"error",title:"오류",text:"클래스 정보를 찾을 수 없습니다."});return}const t=_.homeroomTeacherId||_.homeroom_teacher_id||_.homeroom_teacher||_.teacher_id||"",s=_.homeroomTeacher||_.homeroom_teacher||_.homeroom_teacher_name||_.teacher_name||_.teacher||"알 수 없음",a=_.homeroomTeacherEmail||_.homeroom_teacher_email||_.teacher_email||_.email||"";console.log("=== 담임교사 정보 추출 결과 ==="),console.log("homeroomTeacherId:",t),console.log("homeroomTeacherName:",s),console.log("homeroomTeacherEmail:",a);const n={studentId:b.id,student_id:b.id,studentName:b.name,student_name:b.name,studentEmail:b.email||"",student_email:b.email||"",classId:_.id,class_id:_.id,className:_.name||`${b.grade}학년 ${b.class}반`,class_name:_.name||`${b.grade}학년 ${b.class}반`,studentGrade:_.grade||b.grade,studentClass:_.name||`${b.grade}학년 ${b.class}반`,grade:_.grade||b.grade,homeroomTeacherId:t,homeroom_teacher_id:t,homeroomTeacher:s,homeroom_teacher:s,homeroomTeacherEmail:a,homeroom_teacher_email:a,requester_id:r.uid,requester_name:r.displayName||r.name||r.email,requester_email:r.email,requester_role:"homeroom_teacher",requestingTeacherId:r.uid,requestingTeacherName:r.displayName||r.name||r.email,requestingTeacherRole:"homeroom_teacher",requestingTeacherUid:r.uid,type:S.type,points:S.type==="demerit"?-Math.abs(parseInt(S.points)):Math.abs(parseInt(S.points)),value:S.type==="demerit"?-Math.abs(parseInt(S.points)):Math.abs(parseInt(S.points)),reason:S.reason,description:S.description||S.reason,status:"pending",requestedAt:new Date,createdAt:new Date};console.log("요청 데이터:",n),await pe(q(T,"merit_demerit_requests"),n),await Xe(r.uid,"merit_request_created",`학년 관리에서 상벌점 요청 생성: ${b.name} (${S.type==="merit"?"상점":"벌점"} ${S.type==="demerit"?-Math.abs(parseInt(S.points)):Math.abs(parseInt(S.points))}점)`,{student_id:b.id,student_name:b.name,class_id:_.id,class_name:_.name,points:S.type==="demerit"?-Math.abs(parseInt(S.points)):Math.abs(parseInt(S.points)),reason:S.reason}),await N.fire({icon:"success",title:"요청 완료",text:"상벌점 요청이 성공적으로 전송되었습니다."}),we(!1),nt(null),oe({type:"merit",points:"",reason:"",description:""})}catch(t){console.error("상벌점 요청 오류:",t),await N.fire({icon:"error",title:"요청 실패",text:"상벌점 요청 중 오류가 발생했습니다."})}},dr=async()=>{try{await Dt()}catch{}};return!r||r.role!=="homeroom_teacher"?null:kt?e.jsx(w,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},children:e.jsx(j,{variant:"h6",children:"데이터를 불러오는 중..."})}):ot?e.jsxs(w,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:"100vh",p:3},children:[e.jsx(j,{variant:"h6",color:"error",gutterBottom:!0,children:"오류가 발생했습니다"}),e.jsx(j,{variant:"body1",color:"text.secondary",align:"center",gutterBottom:!0,children:ot}),e.jsx(C,{variant:"contained",onClick:()=>window.location.reload(),sx:{mt:2},children:"페이지 새로고침"})]}):e.jsxs(w,{sx:{display:"flex",minHeight:"100vh",maxWidth:"100vw",overflowX:"hidden"},children:[k&&e.jsx(yt,{onClick:Ze,sx:{position:"fixed",top:16,left:16,zIndex:1300,backgroundColor:"white",boxShadow:2,"&:hover":{backgroundColor:"grey.100"}},children:e.jsx(mr,{})}),e.jsxs(gr,{variant:k?"temporary":"permanent",open:Ye,onClose:Ze,sx:{width:he?200:be?240:280,flexShrink:0,"& .MuiDrawer-paper":{width:he?200:be?240:280,boxSizing:"border-box",backgroundColor:Bt.palette.primary.main,color:"white",height:"100vh",display:"flex",flexDirection:"column"}},children:[e.jsxs(w,{sx:{p:he?1.5:be?2:3,textAlign:"center"},children:[e.jsx(w,{sx:{mb:2},children:e.jsx("img",{src:qr,alt:"로고",style:{width:"50px",height:"50px"}})}),e.jsx(j,{variant:he?"body1":"h6",sx:{fontWeight:"bold",mb:1},children:"담임교사 대시보드"}),e.jsx(j,{variant:he?"caption":"body2",sx:{opacity:.8},children:r.name})]}),e.jsx(wt,{sx:{backgroundColor:"rgba(255,255,255,0.2)"}}),e.jsx(xr,{sx:{mt:2,flexGrow:1,overflowY:"auto","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb:hover":{background:"rgba(255,255,255,0.5)"}},children:[{text:"학생 관리",icon:e.jsx(Ke,{}),value:0},{text:"승인 대기",icon:e.jsx(It,{}),value:1},{text:"상벌점 기록",icon:e.jsx(pr,{}),value:2},{text:"학년 관리",icon:e.jsx(Ke,{}),value:3}].map(t=>e.jsx(fr,{disablePadding:!0,children:e.jsxs(jr,{onClick:()=>{Tt(t.value),k&&Je(!1)},selected:de===t.value,sx:{"&.Mui-selected":{backgroundColor:"rgba(255,255,255,0.1)"},"&:hover":{backgroundColor:"rgba(255,255,255,0.05)"}},children:[e.jsx(yr,{sx:{color:"white",minWidth:40},children:t.icon}),e.jsx(wr,{primary:t.text})]})},t.text))}),e.jsxs(w,{sx:{mt:"auto",p:2},children:[tt.length>0&&e.jsxs(w,{sx:{position:"relative",mb:1},children:[e.jsx(C,{fullWidth:!0,variant:"outlined",startIcon:e.jsx(Ir,{}),onClick:()=>Lt(!0),sx:{color:"white",borderColor:"white","&:hover":{borderColor:"white",backgroundColor:"rgba(255,255,255,0.1)"}},children:"초기화 동의"}),e.jsx(Sr,{badgeContent:tt.length,color:"error",sx:{position:"absolute",top:-8,right:-8}})]}),e.jsx(C,{fullWidth:!0,variant:"outlined",startIcon:e.jsx(br,{}),onClick:dr,sx:{color:"white",borderColor:"white","&:hover":{borderColor:"white",backgroundColor:"rgba(255,255,255,0.1)"}},children:"로그아웃"})]})]}),e.jsxs(w,{sx:{flexGrow:1,overflow:"auto",p:3,display:"flex",flexDirection:"column",alignItems:"center",width:"100%",maxWidth:"100%"},children:[e.jsx(w,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4,width:"100%",maxWidth:"100%"},children:e.jsxs(j,{variant:"h5",component:"h1",sx:{fontWeight:"bold"},children:[r.name,"선생님"]})}),e.jsxs(Pe,{container:!0,spacing:3,sx:{mb:4,width:"100%",maxWidth:"100%"},children:[e.jsx(Pe,{item:!0,xs:12,sm:4,children:e.jsx(ae,{sx:{height:"100%",display:"flex"},children:e.jsxs(ne,{sx:{textAlign:"center",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"100%"},children:[e.jsx(Ke,{sx:{fontSize:40,color:"primary.main",mb:1}}),e.jsx(j,{variant:"h4",children:v.length}),e.jsx(j,{variant:"body1",color:"text.secondary",children:"담당 학생 수"})]})})}),e.jsx(Pe,{item:!0,xs:12,sm:4,children:e.jsx(ae,{sx:{height:"100%",display:"flex"},children:e.jsxs(ne,{sx:{textAlign:"center",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"100%"},children:[e.jsx(It,{sx:{fontSize:40,color:"warning.main",mb:1}}),e.jsx(j,{variant:"h4",children:Pt.requestedToMe}),e.jsx(j,{variant:"body1",color:"text.secondary",children:"대기 중인 요청"})]})})})]}),e.jsxs(w,{sx:{width:"100%",maxWidth:"100%"},children:[de===0&&e.jsx(ae,{children:e.jsxs(ne,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"학생 관리"}),e.jsx(w,{sx:{overflowX:"auto"},children:e.jsxs(ie,{sx:{tableLayout:"auto"},children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>ze("name"),children:["이름 ",A.key==="name"&&(A.direction==="asc"?"↑":"↓")]}),!k&&e.jsxs(e.Fragment,{children:[e.jsx(c,{children:"학년"}),e.jsx(c,{children:"반"})]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>ze("studentId"),children:["학번 ",A.key==="studentId"&&(A.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>ze("cumulativeScore"),children:["상벌점 ",A.key==="cumulativeScore"&&(A.direction==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{whiteSpace:"nowrap"},children:"상벌점 등록"})]})}),e.jsx(le,{children:Xt.map(t=>e.jsxs(G,{children:[e.jsx(c,{children:t.name}),!k&&e.jsxs(e.Fragment,{children:[e.jsx(c,{children:t.grade}),e.jsx(c,{children:t.class})]}),e.jsx(c,{children:t.studentId||t.id}),e.jsx(c,{children:e.jsx(Z,{label:`${t.cumulativeScore||0}점`,color:t.cumulativeScore>0?"success":t.cumulativeScore<0?"error":"default",size:"small"})}),e.jsx(c,{children:e.jsxs(w,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(C,{variant:"contained",size:"small",onClick:()=>{ge(t),me(!0)},children:"상벌점 등록"}),e.jsx(C,{variant:"outlined",size:"small",onClick:async()=>{const s=await Jt(t.id);Ht({...t,meritHistory:s}),_e(!0)},children:"자세히"})]})})]},t.id))})]})})]})}),de===1&&e.jsx(ae,{children:e.jsxs(ne,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"승인 대기"}),e.jsx(w,{sx:{overflowX:"auto"},children:e.jsxs(ie,{children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsx(c,{children:"학생"}),e.jsx(c,{children:"요청자"}),e.jsx(c,{children:"점수"}),e.jsx(c,{children:"사유"}),e.jsx(c,{children:"상세설명"}),e.jsx(c,{children:"요청일"}),e.jsx(c,{children:"액션"})]})}),e.jsx(le,{children:F.map(t=>e.jsxs(G,{children:[e.jsx(c,{children:t.studentName}),e.jsx(c,{children:t.requesterName}),e.jsx(c,{children:e.jsx(Z,{label:`${t.points>0?"+":""}${t.points}`,color:t.points>0?"success":"error",size:"small",variant:"outlined"})}),e.jsx(c,{children:t.reason}),e.jsx(c,{children:t.description||""}),e.jsx(c,{children:t.createdAt?.toLocaleString?.("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})||"N/A"}),e.jsxs(c,{children:[e.jsx(C,{variant:"contained",color:"success",size:"small",onClick:()=>Ot(t.id),sx:{mr:1},children:"승인"}),e.jsx(C,{variant:"contained",color:"error",size:"small",onClick:()=>Qt(t.id),children:"거부"})]})]},t.id))})]})})]})}),de===2&&e.jsx(ae,{children:e.jsxs(ne,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"상벌점 기록"}),e.jsx(w,{sx:{overflowX:"auto"},children:e.jsxs(ie,{children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",fontWeight:"bold"},onClick:()=>Te("studentName"),children:["학생 ",$.key==="studentName"&&($.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",fontWeight:"bold"},onClick:()=>Te("points"),children:["점수 ",$.key==="points"&&($.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",fontWeight:"bold"},onClick:()=>Te("reason"),children:["사유 ",$.key==="reason"&&($.direction==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{fontWeight:"bold"},children:"상세설명"}),e.jsx(c,{sx:{fontWeight:"bold"},children:"요청/처리 교사"}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",fontWeight:"bold"},onClick:()=>Te("createdAt"),children:["처리일시 ",$.key==="createdAt"&&($.direction==="asc"?"↑":"↓")]})]})}),e.jsx(le,{children:J.length===0?e.jsx(G,{children:e.jsx(c,{colSpan:6,align:"center",children:"상벌점 기록이 없습니다."})}):J.map(t=>{const s=t.source==="request",a=t.status||"approved";return e.jsxs(G,{children:[e.jsx(c,{children:t.studentName||"알 수 없음"}),e.jsx(c,{children:e.jsx(Z,{label:`${t.points>0?"+":""}${t.points}`,color:t.points>0?"success":"error",size:"small",variant:"outlined"})}),e.jsx(c,{children:t.reason||""}),e.jsx(c,{children:t.description||""}),e.jsx(c,{children:s?e.jsxs(w,{children:[e.jsxs(j,{variant:"body2",children:["요청: ",t.requestingTeacherName||t.teacherName||"알 수 없음"]}),a==="approved"&&e.jsxs(j,{variant:"caption",color:"success.main",children:["처리: ",t.processedTeacherName||r.name||"담임교사"]}),a==="rejected"&&e.jsx(j,{variant:"caption",color:"error.main",children:"거절됨"})]}):t.processedTeacherName||t.teacherName||t.creatorName||t.requestingTeacherName||"N/A"}),e.jsx(c,{children:s?e.jsxs(w,{children:[e.jsx(Z,{label:a==="approved"?"승인":a==="rejected"?"거절":"대기",color:a==="approved"?"success":a==="rejected"?"error":"warning",size:"small",sx:{mb:.5}}),e.jsx(j,{variant:"caption",display:"block",children:t.createdAt?.toLocaleString?.("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})||"N/A"}),t.responseAt&&e.jsxs(j,{variant:"caption",color:"text.secondary",display:"block",children:["처리: ",t.responseAt.toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})]})]}):t.createdAt?.toLocaleString?.("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})||"N/A"})]},t.id)})})]})})]})}),de===3&&e.jsx(ae,{children:e.jsxs(ne,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"학년 관리"}),e.jsx(w,{sx:{borderBottom:1,borderColor:"divider",mb:3},children:e.jsxs(_r,{value:Be,onChange:(t,s)=>Gt(s),children:[e.jsx(St,{label:"학생 목록"}),e.jsx(St,{label:"요청 내역"})]})}),Be===0&&e.jsxs(w,{children:[e.jsx(j,{variant:"h6",sx:{fontWeight:"bold",mb:2},children:"같은 학년 학생 목록"}),e.jsx(w,{sx:{mb:3},children:e.jsx(ee,{fullWidth:!0,placeholder:"학생 이름, 학번, 담임교사로 검색...",value:ue,onChange:t=>lt(t.target.value),InputProps:{startAdornment:e.jsx(bt,{position:"start",children:e.jsx(Dr,{})}),endAdornment:ue&&e.jsx(bt,{position:"end",children:e.jsx(yt,{size:"small",onClick:()=>lt(""),children:e.jsx(vr,{})})})},sx:{maxWidth:400}})}),re.length===0?e.jsx(w,{sx:{textAlign:"center",py:4},children:e.jsx(j,{variant:"body1",color:"text.secondary",children:"같은 학년의 다른 반 학생이 없습니다."})}):ut.length===0?e.jsx(w,{sx:{textAlign:"center",py:4},children:e.jsx(j,{variant:"body1",color:"text.secondary",children:"검색 결과가 없습니다."})}):e.jsx(w,{sx:{overflowX:"auto"},children:e.jsxs(ie,{sx:{tableLayout:"fixed",minWidth:k?"600px":"100%"},children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap",width:k?"80px":"100px"},onClick:()=>He("studentId"),children:["학번 ",W.key==="studentId"&&(W.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap",width:k?"80px":"100px"},onClick:()=>He("name"),children:["이름 ",W.key==="name"&&(W.direction==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{whiteSpace:"nowrap",width:k?"100px":"120px"},children:"학년/반/번호"}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap",width:k?"120px":"150px"},onClick:()=>He("homeroomTeacher"),children:["담임교사 ",W.key==="homeroomTeacher"&&(W.direction==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{whiteSpace:"nowrap",width:k?"80px":"100px"},children:"누계 점수"}),e.jsx(c,{sx:{whiteSpace:"nowrap",width:k?"100px":"120px"},children:"작업"})]})}),e.jsx(le,{children:ut.map(t=>e.jsxs(G,{children:[e.jsx(c,{children:t.studentId||t.id}),e.jsx(c,{children:t.name}),e.jsxs(c,{children:[t.grade,"학년 ",t.class,"반 ",t.number,"번"]}),e.jsx(c,{children:qe(t)}),e.jsx(c,{children:e.jsx(Z,{label:`${t.cumulativeScore||0}점`,color:t.cumulativeScore>0?"success":t.cumulativeScore<0?"error":"default",size:"small"})}),e.jsx(c,{children:e.jsx(C,{variant:"outlined",size:"small",onClick:()=>cr(t),startIcon:e.jsx(_t,{}),children:"상벌점 요청"})})]},t.id))})]})})]}),Be===1&&e.jsxs(w,{children:[e.jsx(j,{variant:"h6",sx:{fontWeight:"bold",mb:2},children:"학년 관리 요청 내역"}),e.jsx(w,{sx:{overflowX:"auto"},children:e.jsxs(ie,{sx:{tableLayout:"auto"},children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>Ce("studentName"),children:["학생 ",U.key==="studentName"&&(U.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>Ce("requesterName"),children:["요청자 ",U.key==="requesterName"&&(U.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>Ce("requestContent"),children:["요청 내용 ",U.key==="requestContent"&&(U.direction==="asc"?"↑":"↓")]}),e.jsxs(c,{sx:{cursor:"pointer",userSelect:"none",whiteSpace:"nowrap"},onClick:()=>Ce("createdAt"),children:["요청일 ",U.key==="createdAt"&&(U.direction==="asc"?"↑":"↓")]}),e.jsx(c,{sx:{whiteSpace:"nowrap"},children:"액션"})]})}),e.jsx(le,{children:ir.map(t=>e.jsxs(G,{children:[e.jsx(c,{children:t.studentName}),e.jsx(c,{children:t.requesterName}),e.jsx(c,{children:t.requestContent}),e.jsx(c,{children:t.createdAt?.toDate?.()?.toLocaleDateString()||"N/A"}),e.jsxs(c,{children:[e.jsx(C,{variant:"contained",color:"success",size:"small",onClick:()=>sr(t.id),sx:{mr:1},children:"승인"}),e.jsx(C,{variant:"contained",color:"error",size:"small",onClick:()=>ar(t.id),children:"거부"})]})]},t.id))})]})})]})]})})]})]}),e.jsxs(Ae,{open:Wt,onClose:()=>me(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Re,{children:"상벌점 등록"}),e.jsx(Ne,{children:e.jsxs(w,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1,maxWidth:"500px",mx:"auto"},children:[e.jsxs(P,{fullWidth:!0,children:[e.jsx(O,{children:"학생"}),e.jsx(Q,{value:y?y.id:"",onChange:t=>ge(v.find(s=>s.id===t.target.value)),label:"학생",size:"medium",children:v.map(t=>e.jsxs(z,{value:t.id,children:[t.name," (",t.studentId,")"]},t.id))})]}),e.jsxs(P,{fullWidth:!0,children:[e.jsx(O,{children:"구분"}),e.jsxs(Q,{value:x.type||"demerit",onChange:t=>H({...x,type:t.target.value}),label:"구분",size:"medium",children:[e.jsx(z,{value:"merit",children:"상점"}),e.jsx(z,{value:"demerit",children:"벌점"})]})]}),e.jsx(ee,{fullWidth:!0,label:"점수",type:"number",value:x.value||1,onChange:t=>H({...x,value:parseInt(t.target.value)}),inputProps:{min:1},required:!0,size:"medium"}),e.jsxs(P,{fullWidth:!0,children:[e.jsx(O,{children:"사유"}),e.jsx(Q,{value:x.reason||"",onChange:t=>H({...x,reason:t.target.value}),label:"사유",size:"medium",children:Me.filter(t=>t.type===x.type).map(t=>e.jsx(z,{value:t.reason,children:t.reason},t.id))})]}),e.jsx(ee,{fullWidth:!0,label:"상세 내용",multiline:!0,rows:3,value:x.description||"",onChange:t=>H({...x,description:t.target.value}),size:"medium"})]})}),e.jsxs(ke,{children:[e.jsx(C,{onClick:()=>me(!1),children:"취소"}),e.jsx(C,{onClick:Zt,variant:"contained",children:"등록"})]})]}),e.jsxs(Ae,{open:zt,onClose:()=>We(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Re,{children:"상벌점 요청"}),e.jsx(Ne,{children:e.jsxs(w,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1,maxWidth:"500px",mx:"auto"},children:[e.jsxs(P,{fullWidth:!0,children:[e.jsx(O,{children:"학생"}),e.jsx(Q,{value:y?y.id:"",onChange:t=>ge(v.find(s=>s.id===t.target.value)),label:"학생",size:"medium",children:v.map(t=>e.jsxs(z,{value:t.id,children:[t.name," (",t.studentId,")"]},t.id))})]}),e.jsxs(P,{fullWidth:!0,children:[e.jsx(O,{children:"구분"}),e.jsxs(Q,{value:x.type||"demerit",onChange:t=>H({...x,type:t.target.value}),label:"구분",size:"medium",children:[e.jsx(z,{value:"merit",children:"상점"}),e.jsx(z,{value:"demerit",children:"벌점"})]})]}),e.jsx(ee,{fullWidth:!0,label:"점수",type:"number",value:x.value||1,onChange:t=>H({...x,value:parseInt(t.target.value)}),inputProps:{min:1},required:!0,size:"medium"}),e.jsxs(P,{fullWidth:!0,children:[e.jsx(O,{children:"사유"}),e.jsx(Q,{value:x.reason||"",onChange:t=>H({...x,reason:t.target.value}),label:"사유",size:"medium",children:Me.filter(t=>t.type===x.type).map(t=>e.jsx(z,{value:t.reason,children:t.reason},t.id))})]}),e.jsx(ee,{fullWidth:!0,label:"상세 내용",multiline:!0,rows:3,value:x.description||"",onChange:t=>H({...x,description:t.target.value}),size:"medium"})]})}),e.jsxs(ke,{children:[e.jsx(C,{onClick:()=>We(!1),children:"취소"}),e.jsx(C,{onClick:()=>{console.log("상벌점 요청:",x),We(!1)},variant:"contained",children:"요청"})]})]}),e.jsxs(Ae,{open:$t,onClose:()=>we(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Re,{children:"상벌점 요청"}),e.jsx(Ne,{children:b&&e.jsxs(w,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1,maxWidth:"500px",mx:"auto"},children:[e.jsxs(w,{children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"학생 정보"}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"이름:"})," ",b.name]}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"학년/반/번호:"})," ",b.grade,"학년 ",b.class,"반 ",b.number,"번"]}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"담임교사:"})," ",qe(b)]})]}),e.jsx(wt,{}),e.jsx(j,{variant:"h6",gutterBottom:!0,children:"상벌점 정보"}),e.jsxs(P,{fullWidth:!0,required:!0,children:[e.jsx(O,{children:"상벌점 유형"}),e.jsxs(Q,{value:S.type,onChange:t=>oe({...S,type:t.target.value,reason:""}),label:"상벌점 유형",size:"medium",children:[e.jsx(z,{value:"merit",children:"상점"}),e.jsx(z,{value:"demerit",children:"벌점"})]})]}),e.jsx(ee,{fullWidth:!0,label:"점수",type:"number",value:S.points,onChange:t=>oe({...S,points:t.target.value}),required:!0,placeholder:"점수를 입력하세요",size:"medium"}),e.jsxs(P,{fullWidth:!0,required:!0,children:[e.jsx(O,{children:"사유"}),e.jsx(Q,{value:S.reason,onChange:t=>oe({...S,reason:t.target.value}),label:"사유",size:"medium",children:Me.filter(t=>t.type===S.type).map(t=>e.jsx(z,{value:t.reason,children:t.reason},t.id))})]}),e.jsx(ee,{fullWidth:!0,label:"상세 설명",value:S.description,onChange:t=>oe({...S,description:t.target.value}),multiline:!0,rows:4,placeholder:"상세한 설명을 입력하세요 (선택사항)",size:"medium"})]})}),e.jsxs(ke,{children:[e.jsx(C,{onClick:()=>we(!1),children:"취소"}),e.jsx(C,{onClick:lr,variant:"contained",children:"요청 전송"})]})]}),e.jsxs(Ae,{open:Ut,onClose:()=>_e(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Re,{children:"학생 상세 정보"}),e.jsx(Ne,{children:M&&e.jsxs(w,{sx:{mt:2},children:[e.jsxs(w,{sx:{mb:3,p:2,backgroundColor:"#f5f5f5",borderRadius:1},children:[e.jsx(j,{variant:"h6",gutterBottom:!0,children:"학생 정보"}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"이름:"})," ",M.name]}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"학번:"})," ",M.studentId||M.id]}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"학년/반/번호:"})," ",M.grade,"학년 ",M.class,"반 ",M.number,"번"]}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"생년월일:"})," ",M.birthDate||"N/A"]}),e.jsxs(j,{variant:"body1",gutterBottom:!0,children:[e.jsx("strong",{children:"누적 점수:"})," ",M.cumulativeScore||0,"점"]})]}),e.jsxs(w,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(j,{variant:"h6",children:"상벌점 기록"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(_t,{}),onClick:()=>{ge(M),_e(!1),me(!0)},children:"상벌점 추가"})]}),M?.meritHistory&&M.meritHistory.length>0?e.jsxs(ie,{children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsx(c,{children:"날짜"}),e.jsx(c,{children:"구분"}),e.jsx(c,{children:"점수"}),e.jsx(c,{children:"사유"}),e.jsx(c,{children:"상세 내용"}),e.jsx(c,{children:"처리 교사"})]})}),e.jsx(le,{children:M.meritHistory.map(t=>e.jsxs(G,{children:[e.jsx(c,{children:t.createdAt?.toLocaleString?.("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})||"N/A"}),e.jsx(c,{children:e.jsx(Z,{label:t.type==="merit"?"상점":"벌점",color:t.type==="merit"?"success":"error",size:"small"})}),e.jsx(c,{children:e.jsx(Z,{label:`${t.points||0}점`,color:t.points>0?"success":t.points<0?"error":"default",size:"small"})}),e.jsx(c,{children:t.reason||"N/A"}),e.jsx(c,{children:t.description||""}),e.jsx(c,{children:t.processedTeacherName||"N/A"})]},t.id))})]}):e.jsx(w,{sx:{textAlign:"center",py:4},children:e.jsx(j,{variant:"body1",color:"text.secondary",children:"상벌점 기록이 없습니다."})})]})}),e.jsx(ke,{children:e.jsx(C,{onClick:()=>_e(!1),children:"닫기"})})]})]})};export{lo as default};
