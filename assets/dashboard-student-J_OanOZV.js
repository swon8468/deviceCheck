import{r as u,j as e,B as m,C as k,T as d,b as E,c as F,m as f,w as H,ab as P,U,V,W as _,e as $,P as K,f as N,g as X,h as y,i as l,k as q,l as v,ac as G,ad as J,X as O,A as Q,aa as Y}from"./vendor-mui-EHn5RoE1.js";import{u as Z,a as ee,c as te,d as se,q as ne,w as oe,o as le}from"./dashboard-admin-zNdg3Xgx.js";import"./vendor-react-COd4auuD.js";const xe=()=>{const{currentUser:o,logout:C}=Z(),[b,A]=u.useState([]),[g,T]=u.useState({totalMerit:0,totalDemerit:0,netScore:0}),[R,j]=u.useState(!1),[ie,p]=u.useState(!0),D=["수행평가 등으로 인한 상점","모범 학생 상점","봉사 활동 상점","학급 활동 기여 상점","체육 활동 우수 상점","예술 활동 우수 상점","과학 실험 우수 상점","독서 활동 우수 상점","친구 도움 상점","교사 도움 상점","학교 행사 참여 상점","동아리 활동 우수 상점","기타 상점"],I=["휴대폰/태블릿 사용","이어폰 사용","지각","무단 조퇴","복장 불량","수업 태도 불량","수업 중 잡담","수업 중 자리 이탈","수업 준비물 미지참","과제 미제출","시험 부정행위","폭력 행위","욕설/비방","교실 청결 불량","급식 예절 불량","기타 벌점"],{isMobile:s,isTablet:S}=ee();u.useEffect(()=>{if(o){let t=null;return(async()=>{t=await W()})(),()=>{typeof t=="function"&&t()}}},[o]);const W=async()=>{try{p(!0),console.log("=== 학생 상벌점 기록 조회 시작 ==="),console.log("학생 ID:",o.id),console.log("현재 사용자:",o);const t=te(se,"merit_demerit_records"),w=ne(t,oe("studentId","==",o.id));return console.log("Firestore 쿼리 실행 중..."),le(w,a=>{const x=[];let r=0,c=0;console.log("=== Firestore 조회 결과 ==="),console.log("조회된 문서 수:",a.size),console.log("쿼리 스냅샷:",a),a.empty&&(console.log("⚠️ 상벌점 기록이 없습니다!"),console.log("학생 ID로 조회한 결과가 비어있습니다."),console.log("studentId 필드가 올바르게 설정되어 있는지 확인하세요.")),a.forEach(h=>{const n=h.data();console.log("문서 ID:",h.id),console.log("문서 데이터:",n),console.log("studentId 필드:",n.studentId),console.log("type 필드:",n.type),console.log("points 필드:",n.points),console.log("value 필드:",n.value);const i=n.points||n.value||0;console.log("계산된 points:",i),x.push({id:h.id,...n,points:i,value:i,createdAt:n.createdAt?.toDate?.()||new Date(n.createdAt)}),n.type==="merit"?(r+=i,console.log("상점 추가:",i,"총 상점:",r)):n.type==="demerit"&&(c+=Math.abs(i),console.log("벌점 추가:",Math.abs(i),"총 벌점:",c))}),x.sort((h,n)=>new Date(n.createdAt)-new Date(h.createdAt)),console.log("=== 최종 결과 ==="),console.log("처리된 기록 수:",x.length),console.log("총 상점:",r),console.log("총 벌점:",c),console.log("순점수:",r-c),console.log("기록 목록:",x),A(x),T({totalMerit:r,totalDemerit:c,netScore:r-c}),p(!1)},a=>{console.error("Firestore 조회 오류:",a),p(!1)})}catch(t){return console.error("fetchMeritRecords 오류:",t),p(!1),null}},M=async()=>{try{await C()}catch{}},z=t=>t?new Date(t).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",B=t=>t==="merit"?"success":"error",L=t=>t==="merit"?e.jsx(Q,{}):e.jsx(Y,{});return o?e.jsx(m,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",width:"100%"},children:e.jsxs(k,{maxWidth:"md",sx:{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",py:4},children:[e.jsx(m,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:4,width:"100%",flexDirection:s?"column":"row",gap:s?2:0},children:e.jsxs(m,{sx:{textAlign:s?"center":"left"},children:[e.jsx(d,{variant:s?"h5":S?"h4":"h3",component:"h1",gutterBottom:!0,sx:{fontWeight:"bold"},children:"학생 대시보드"}),e.jsxs(d,{variant:s?"body1":"h6",color:"text.secondary",sx:{mb:1,textAlign:"center"},children:[o.name," (",o.grade,"학년 ",o.class,"반 ",o.number,"번)"]})]})}),e.jsx(E,{sx:{mb:4,width:"100%",maxWidth:"400px"},children:e.jsxs(F,{sx:{textAlign:"center"},children:[e.jsx(d,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"현재 누적 점수"}),e.jsxs(d,{variant:"h3",color:g.netScore>=0?"success.main":"error.main",sx:{fontWeight:"bold"},children:[g.netScore,"점"]}),e.jsxs(d,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["상점: ",g.totalMerit,"점 | 벌점: ",g.totalDemerit,"점"]})]})}),e.jsxs(m,{sx:{display:"flex",gap:2,mb:3,width:"100%",justifyContent:"center",flexDirection:s?"column":"row",alignItems:"center"},children:[e.jsx(f,{variant:"outlined",startIcon:e.jsx(H,{}),onClick:M,size:s?"medium":"large",fullWidth:s,sx:{maxWidth:s?"100%":"200px"},children:"메인화면"}),e.jsx(f,{variant:"contained",startIcon:e.jsx(P,{}),onClick:()=>j(!0),size:s?"medium":"large",fullWidth:s,sx:{maxWidth:s?"100%":"200px"},children:"자세히 보기"})]}),e.jsxs(U,{open:R,onClose:()=>j(!1),maxWidth:s?"xs":"md",fullWidth:!0,children:[e.jsx(V,{children:"상벌점 상세 내역"}),e.jsx(_,{children:e.jsx("div",{className:"table-scroll-container",children:e.jsx($,{component:K,children:e.jsxs(N,{size:s?"small":"medium",children:[e.jsx(X,{children:e.jsxs(y,{children:[e.jsx(l,{children:"날짜"}),e.jsx(l,{children:"구분"}),e.jsx(l,{children:"점수"}),e.jsx(l,{sx:{minWidth:200},children:"사유"})]})}),e.jsx(q,{children:b.length===0?e.jsx(y,{children:e.jsx(l,{colSpan:4,align:"center",children:"상벌점 기록이 없습니다."})}):b.map(t=>e.jsxs(y,{children:[e.jsx(l,{children:z(t.createdAt)}),e.jsx(l,{children:e.jsx(v,{icon:L(t.type),label:t.type==="merit"?"상점":"벌점",color:B(t.type),size:"small"})}),e.jsx(l,{children:e.jsx(v,{label:`${t.points>0?"+":""}${t.points}점`,color:t.points>0?"success":"error",size:"small",variant:"outlined"})}),e.jsx(l,{children:e.jsx(G,{title:t.reason,placement:"top",children:e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(d,{variant:"body2",children:t.type==="merit"?D.includes(t.reason)?t.reason:"기타 상점":I.includes(t.reason)?t.reason:"기타 벌점"}),t.reason&&!D.includes(t.reason)&&!I.includes(t.reason)&&e.jsx(J,{fontSize:"small",color:"action"})]})})})]},t.id))})]})})})}),e.jsx(O,{children:e.jsx(f,{onClick:()=>j(!1),children:"닫기"})})]})]})}):null};export{xe as default};
